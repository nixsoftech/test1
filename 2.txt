- name: Install required Python APT library
  block:
    - name: Ensure APT cache is updated
      ansible.builtin.command: apt-get update
      register: apt_update
      until: apt_update.rc == 0
      retries: 5
      delay: 10
      ignore_errors: yes

    - name: Install python3-apt
      ansible.builtin.apt:
        name: python3-apt
        state: present
        update_cache: no  # Already handled by previous task
      register: install_result
      until: install_result is succeeded
      retries: 3
      delay: 15

  when: ansible_distribution == 'Ubuntu'
